<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teyvat Math Adventure - IB Pre-DP Quest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.2em;
            color: #666;
        }

        .map-container {
            width: 100%;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            border: 3px solid #667eea;
        }

        .map-title {
            text-align: center;
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .map-path {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 20px 0;
        }

        .map-path::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #ddd;
            z-index: 0;
        }

        .location {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            background: white;
            border: 4px solid #ddd;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .location.visited {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
        }

        .location.current {
            border-color: #f5576c;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 30px rgba(245, 87, 108, 0.7);
        }

        .location-name {
            font-size: 0.35em;
            margin-top: 5px;
            font-weight: bold;
            color: #333;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .character-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
        }

        .character-name {
            font-size: 1.5em;
            color: #764ba2;
            font-weight: bold;
        }

        .primogems {
            font-size: 1.3em;
            color: #f5576c;
            font-weight: bold;
        }

        .question-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .question-number {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .question-text {
            font-size: 1.2em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
        }

        .diagram {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 2px dashed #667eea;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .hint-btn {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #764ba2;
            padding: 12px 30px;
            font-size: 1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-right: 10px;
        }

        .hint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(252, 182, 159, 0.4);
        }

        .hint-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .show-answer-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #333;
            padding: 12px 30px;
            font-size: 1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-right: 10px;
        }

        .show-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(250, 112, 154, 0.4);
        }

        .show-answer-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .answer-explanation {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            color: #2e7d32;
            line-height: 1.6;
        }

        .answer-explanation strong {
            color: #1b5e20;
        }

        /* Mini-game modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            font-size: 2em;
            color: #667eea;
            text-align: center;
            margin-bottom: 20px;
        }

        .mini-game-container {
            margin: 20px 0;
        }

        /* Slime Whacker game styles */
        .slime-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .slime-hole {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #8B7355 0%, #A0826D 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            border: 4px solid #654321;
            transition: all 0.1s;
        }

        .slime-hole:active {
            transform: scale(0.95);
        }

        .slime {
            font-size: 3em;
            animation: slimePop 0.5s ease-out;
        }

        @keyframes slimePop {
            0% {
                transform: translateY(50px) scale(0);
            }
            50% {
                transform: translateY(0) scale(1.2);
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        .game-timer {
            font-size: 1.5em;
            color: #f5576c;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .game-score {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .mini-game-result {
            text-align: center;
            font-size: 1.4em;
            color: #4caf50;
            font-weight: bold;
            margin: 20px 0;
        }

        .continue-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: block;
            margin: 20px auto;
        }

        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .feedback {
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.1em;
            text-align: center;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .final-score {
            text-align: center;
            padding: 40px;
        }

        .final-score h2 {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .final-score p {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
        }

        .restart-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .hint-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #856404;
        }

        .hidden {
            display: none;
        }

        canvas {
            max-width: 100%;
            border-radius: 8px;
            background: white;
            display: block;
            margin: 15px auto;
            border: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1 class="title">‚öîÔ∏è Teyvat Math Adventure ‚öîÔ∏è</h1>
            <p class="subtitle">Complete the quest to earn Primogems!</p>
        </div>

        <div class="map-container">
            <div class="map-title">üó∫Ô∏è Journey Through Teyvat üó∫Ô∏è</div>
            <div class="map-path" id="mapPath">
                <div class="location current" id="location0">
                    <span>üè∞</span>
                    <div class="location-name">Mondstadt</div>
                </div>
                <div class="location" id="location1">
                    <span>‚õ∞Ô∏è</span>
                    <div class="location-name">Dragonspine</div>
                </div>
                <div class="location" id="location2">
                    <span>üèØ</span>
                    <div class="location-name">Liyue</div>
                </div>
                <div class="location" id="location3">
                    <span>‚ö°</span>
                    <div class="location-name">Inazuma</div>
                </div>
                <div class="location" id="location4">
                    <span>üåø</span>
                    <div class="location-name">Sumeru</div>
                </div>
                <div class="location" id="location5">
                    <span>‚öñÔ∏è</span>
                    <div class="location-name">Fontaine</div>
                </div>
            </div>
        </div>

        <div class="character-info">
            <div class="character-name">üåü Traveler</div>
            <div class="primogems">üíé Primogems: <span id="score">0</span></div>
        </div>

        <div id="questionSection">
            <div class="question-container">
                <div class="question-number" id="questionNumber"></div>
                <div class="question-text" id="questionText"></div>
                <div id="diagramContainer"></div>
                <div id="hintContainer" class="hidden"></div>
                <div id="answerExplanation" class="hidden"></div>
                <input type="number" step="0.01" class="answer-input" id="answerInput" placeholder="Enter your answer...">
                <div class="button-group">
                    <button class="hint-btn" id="hintBtn" onclick="showHint()">üí° Hint (-10 Primogems)</button>
                    <button class="show-answer-btn" id="showAnswerBtn" onclick="showAnswer()">üìñ Show Answer (1 Primogem only)</button>
                    <button class="btn" id="submitBtn" onclick="checkAnswer()">Submit Answer</button>
                </div>
                <div id="feedback"></div>
            </div>
        </div>

        <div id="finalScore" class="final-score hidden">
            <h2>Quest Complete! üéâ</h2>
            <p>You earned <span id="finalPrimogems"></span> Primogems!</p>
            <p id="performanceMessage"></p>
            <button class="btn restart-btn" onclick="restartGame()">Start New Quest</button>
        </div>

        <!-- Mini-game Modal -->
        <div id="miniGameModal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="miniGameTitle">üéÆ Bonus Challenge! üéÆ</div>
                <div id="miniGameContainer" class="mini-game-container"></div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestion = 0;
        let score = 0;
        let questions = [];
        let currentAnswer = 0;
        let hintUsed = false;
        let answerShown = false;
        let maxScore = 20;
        let miniGameTriggered = false;

        // Drawing helper functions
        function drawRightTriangle(canvas, a, b, c, labels) {
            const ctx = canvas.getContext('2d');
            const maxDim = Math.max(a, b);
            const scale = Math.min(250 / maxDim, 250 / maxDim);
            const padding = 50;
            
            // Adjust canvas size if needed
            canvas.width = Math.max(400, scale * b + 2 * padding);
            canvas.height = Math.max(300, scale * a + 2 * padding);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = '#333';
            
            // Calculate scaled dimensions
            const baseLen = b * scale;
            const heightLen = a * scale;
            
            // Draw triangle (bottom-left corner at origin)
            const startX = padding;
            const startY = canvas.height - padding;
            
            ctx.beginPath();
            ctx.moveTo(startX, startY); // Bottom left
            ctx.lineTo(startX + baseLen, startY); // Bottom right
            ctx.lineTo(startX, startY - heightLen); // Top left
            ctx.closePath();
            ctx.stroke();
            
            // Draw right angle indicator
            const squareSize = 15;
            ctx.strokeRect(startX, startY - squareSize, squareSize, squareSize);
            
            // Add labels with background for readability
            ctx.textAlign = 'center';
            ctx.fillText(labels.base || `${b}m`, startX + baseLen/2, startY + 30);
            ctx.textAlign = 'right';
            ctx.fillText(labels.height || `${a}m`, startX - 10, startY - heightLen/2 + 5);
            ctx.textAlign = 'center';
            ctx.fillStyle = '#f5576c';
            ctx.fillText(labels.hypotenuse || `${c.toFixed(1)}m`, startX + baseLen/2 + 20, startY - heightLen/2 - 15);
        }

        function drawCircle(canvas, radius, showChord = false, chordDistance = 0) {
            const ctx = canvas.getContext('2d');
            const scale = Math.min(150 / radius, 150 / radius);
            const padding = 70;
            const scaledRadius = radius * scale;
            
            // Calculate required canvas size FIRST
            const minWidth = 2 * scaledRadius + 2 * padding;
            const minHeight = 2 * scaledRadius + 2 * padding;
            
            canvas.width = Math.max(450, minWidth);
            canvas.height = Math.max(350, minHeight);
            
            // NOW calculate center AFTER canvas is resized
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = '#333';
            
            // Draw circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, scaledRadius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw center point
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw radius line
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + scaledRadius, centerY);
            ctx.stroke();
            
            // Label radius
            ctx.textAlign = 'center';
            ctx.fillText(`r = ${radius}m`, centerX + scaledRadius/2, centerY - 12);
            
            // Draw chord if needed
            if (showChord && chordDistance > 0) {
                const scaledDistance = chordDistance * scale;
                const chordHalf = Math.sqrt(scaledRadius * scaledRadius - scaledDistance * scaledDistance);
                
                // Draw perpendicular from center to chord
                ctx.strokeStyle = '#f5576c';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX, centerY - scaledDistance);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw chord
                ctx.strokeStyle = '#4caf50';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX - chordHalf, centerY - scaledDistance);
                ctx.lineTo(centerX + chordHalf, centerY - scaledDistance);
                ctx.stroke();
                
                // Label distance
                ctx.fillStyle = '#f5576c';
                ctx.textAlign = 'left';
                ctx.fillText(`${chordDistance}m`, centerX + 10, centerY - scaledDistance/2);
            }
        }

        function drawRectangularPrism(canvas, l, w, h) {
            const ctx = canvas.getContext('2d');
            const maxDim = Math.max(l, w, h);
            const scale = Math.min(180 / maxDim, 180 / maxDim);
            
            // Adjust canvas size
            canvas.width = Math.max(450, (l + w) * scale + 120);
            canvas.height = Math.max(350, (h + w) * scale + 120);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#333';
            
            const baseX = 80;
            const baseY = canvas.height - 60;
            const scaledL = l * scale;
            const scaledW = w * scale * 0.5; // Perspective
            const scaledH = h * scale;
            
            // Draw back face (dashed)
            ctx.strokeStyle = '#999';
            ctx.setLineDash([3, 3]);
            ctx.strokeRect(baseX + scaledW, baseY - scaledH - scaledW, scaledL, scaledH);
            ctx.setLineDash([]);
            
            // Draw front face
            ctx.strokeStyle = '#667eea';
            ctx.strokeRect(baseX, baseY - scaledH, scaledL, scaledH);
            
            // Draw connecting lines
            ctx.beginPath();
            ctx.moveTo(baseX, baseY - scaledH);
            ctx.lineTo(baseX + scaledW, baseY - scaledH - scaledW);
            ctx.moveTo(baseX + scaledL, baseY - scaledH);
            ctx.lineTo(baseX + scaledL + scaledW, baseY - scaledH - scaledW);
            ctx.moveTo(baseX + scaledL, baseY);
            ctx.lineTo(baseX + scaledL + scaledW, baseY - scaledW);
            ctx.stroke();
            
            // Labels
            ctx.textAlign = 'center';
            ctx.fillText(`${l}cm`, baseX + scaledL/2, baseY + 20);
            ctx.textAlign = 'right';
            ctx.fillText(`${h}cm`, baseX - 15, baseY - scaledH/2);
            ctx.textAlign = 'left';
            ctx.fillText(`${w}cm`, baseX + scaledL + scaledW/2, baseY - 5);
        }

        function drawCylinder(canvas, radius, height) {
            const ctx = canvas.getContext('2d');
            const maxDim = Math.max(radius, height);
            const scale = Math.min(140 / maxDim, 140 / maxDim);
            
            // Adjust canvas size
            canvas.width = Math.max(400, 2.5 * radius * scale + 100);
            canvas.height = Math.max(350, height * scale + 2 * radius * scale * 0.4 + 80);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#333';
            
            const centerX = canvas.width / 2;
            const topY = 50;
            const scaledR = radius * scale;
            const scaledH = height * scale;
            
            // Draw top ellipse
            ctx.beginPath();
            ctx.ellipse(centerX, topY, scaledR, scaledR * 0.3, 0, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw bottom ellipse
            ctx.beginPath();
            ctx.ellipse(centerX, topY + scaledH, scaledR, scaledR * 0.3, 0, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw sides
            ctx.beginPath();
            ctx.moveTo(centerX - scaledR, topY);
            ctx.lineTo(centerX - scaledR, topY + scaledH);
            ctx.moveTo(centerX + scaledR, topY);
            ctx.lineTo(centerX + scaledR, topY + scaledH);
            ctx.stroke();
            
            // Labels
            ctx.textAlign = 'center';
            ctx.fillText(`r = ${radius}cm`, centerX, topY - 10);
            ctx.textAlign = 'left';
            ctx.fillText(`h = ${height}cm`, centerX + scaledR + 15, topY + scaledH/2);
        }

        function drawTriangle(canvas, base, height) {
            const ctx = canvas.getContext('2d');
            const maxDim = Math.max(base, height);
            const scale = Math.min(250 / maxDim, 250 / maxDim);
            const padding = 50;
            
            // Adjust canvas size
            canvas.width = Math.max(400, base * scale + 2 * padding);
            canvas.height = Math.max(300, height * scale + 2 * padding);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = '#333';
            
            const scaledBase = base * scale;
            const scaledHeight = height * scale;
            
            const startX = (canvas.width - scaledBase) / 2;
            const startY = canvas.height - padding;
            
            // Draw triangle
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(startX + scaledBase, startY);
            ctx.lineTo(startX + scaledBase/2, startY - scaledHeight);
            ctx.closePath();
            ctx.stroke();
            
            // Draw height line
            ctx.strokeStyle = '#f5576c';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(startX + scaledBase/2, startY);
            ctx.lineTo(startX + scaledBase/2, startY - scaledHeight);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText(`base = ${base}m`, startX + scaledBase/2, startY + 30);
            ctx.fillStyle = '#f5576c';
            ctx.textAlign = 'left';
            ctx.fillText(`h = ${height}m`, startX + scaledBase/2 + 15, startY - scaledHeight/2);
        }

        // Question generators for each topic
        const questionGenerators = [
            generatePythagorasQuestion,
            generateCircleAreaQuestion,
            generateSurfaceAreaQuestion,
            generateVolumeQuestion,
            generateSimilarityQuestion,
            generateUnitCircleQuestion,
            generateBearingsQuestion,
            generateTriangleAreaQuestion,
            generateSineRuleQuestion,
            generateCircleTheoremQuestion
        ];

        function generatePythagorasQuestion() {
            const a = Math.floor(Math.random() * 10) + 3;
            const b = Math.floor(Math.random() * 10) + 3;
            const c = Math.sqrt(a * a + b * b);
            
            const scenarios = [
                {
                    text: `Amber is using her Baron Bunny to measure distances in the Whispering Woods. She throws it ${a} meters north, then runs ${b} meters east to retrieve it. What is the straight-line distance between her starting point and Baron Bunny?`,
                    hint: `Remember the Pythagorean Theorem: a¬≤ + b¬≤ = c¬≤. In this case, you have two legs of a right triangle (${a}m and ${b}m), and you need to find the hypotenuse.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. We have a right triangle with legs a = ${a}m and b = ${b}m<br>
                        2. Using Pythagorean Theorem: c¬≤ = a¬≤ + b¬≤<br>
                        3. c¬≤ = ${a}¬≤ + ${b}¬≤ = ${a*a} + ${b*b} = ${a*a + b*b}<br>
                        4. c = ‚àö${a*a + b*b} = ${c.toFixed(2)} meters<br>
                        <strong>Answer: ${c.toFixed(2)} meters</strong>`,
                    diagram: (canvas) => drawRightTriangle(canvas, a, b, c, {base: `${b}m (East)`, height: `${a}m (North)`, hypotenuse: '?'})
                },
                {
                    text: `Diluc is setting up wine barrel supports at Dawn Winery. A barrel is ${a}m tall and the support beam reaches ${b}m away from the base. How long must the support beam be?`,
                    hint: `This forms a right triangle where the height is ${a}m and the base is ${b}m. Use a¬≤ + b¬≤ = c¬≤ to find the length of the support beam (the hypotenuse).`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. The barrel height and ground distance form a right triangle<br>
                        2. Height = ${a}m, Base = ${b}m, Beam = ?<br>
                        3. Using Pythagorean Theorem: beam¬≤ = ${a}¬≤ + ${b}¬≤<br>
                        4. beam¬≤ = ${a*a} + ${b*b} = ${a*a + b*b}<br>
                        5. beam = ‚àö${a*a + b*b} = ${c.toFixed(2)} meters<br>
                        <strong>Answer: ${c.toFixed(2)} meters</strong>`,
                    diagram: (canvas) => drawRightTriangle(canvas, a, b, c, {base: `${b}m`, height: `${a}m`, hypotenuse: '?'})
                },
                {
                    text: `Zhongli is studying a pillar in the Guili Plains. The pillar is ${a}m high, and a rope reaches from the top to a point ${b}m from the base of the pillar. How long is the rope?`,
                    hint: `You know both legs of the right triangle: height = ${a}m and base = ${b}m. Use the Pythagorean Theorem: c¬≤ = a¬≤ + b¬≤ to find the rope length.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. We have a right triangle with height = ${a}m and base = ${b}m<br>
                        2. Using Pythagorean Theorem: c¬≤ = a¬≤ + b¬≤<br>
                        3. c¬≤ = ${a}¬≤ + ${b}¬≤ = ${a*a} + ${b*b} = ${a*a + b*b}<br>
                        4. c = ‚àö${a*a + b*b} = ${c.toFixed(2)} meters<br>
                        <strong>Answer: ${c.toFixed(2)} meters</strong>`,
                    diagram: (canvas) => drawRightTriangle(canvas, a, b, c, {base: `${b}m`, height: `${a}m`, hypotenuse: '?'})
                }
            ];
            
            const type = Math.floor(Math.random() * 3);
            const answer = c;
            
            return {
                text: scenarios[type].text,
                hint: scenarios[type].hint,
                explanation: scenarios[type].explanation,
                diagram: scenarios[type].diagram,
                answer: answer,
                tolerance: 0.05,
                topic: "Pythagorean Theorem",
                needsRounding: true
            };
        }

        function generateCircleAreaQuestion() {
            const radius = Math.floor(Math.random() * 8) + 3;
            const area = Math.PI * radius * radius;
            
            const scenarios = [
                {
                    text: `Jean is planning a circular training ground in front of the Knights of Favonius headquarters. The radius is ${radius} meters. What is the area of this training ground?`,
                    hint: `The formula for the area of a circle is A = œÄr¬≤. Here, r = ${radius}m. Use œÄ ‚âà 3.14159 and don't forget to square the radius!`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Circle area formula: A = œÄr¬≤<br>
                        2. Given: radius r = ${radius}m<br>
                        3. First, square the radius: ${radius}¬≤ = ${radius * radius}<br>
                        4. Then multiply by œÄ: A = 3.14159 √ó ${radius * radius}<br>
                        5. A = ${area.toFixed(2)} square meters<br>
                        <strong>Answer: ${area.toFixed(2)} m¬≤</strong>`,
                    diagram: (canvas) => drawCircle(canvas, radius, false, 0)
                },
                {
                    text: `Klee is calculating the blast radius of her Jumpy Dumpty. If it forms a perfect circle with radius ${radius}m, what's the area of effect?`,
                    hint: `Use the circle area formula: A = œÄr¬≤. Substitute r = ${radius} and œÄ ‚âà 3.14159. Remember: ${radius}¬≤ = ${radius * radius}.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. We need to find the area of a circle with radius ${radius}m<br>
                        2. Formula: A = œÄr¬≤<br>
                        3. Substitute values: A = œÄ √ó ${radius}¬≤<br>
                        4. Calculate: A = 3.14159 √ó ${radius * radius} = ${area.toFixed(2)}<br>
                        <strong>Answer: ${area.toFixed(2)} m¬≤</strong>`,
                    diagram: (canvas) => drawCircle(canvas, radius, false, 0)
                },
                {
                    text: `Fischl's Oz patrols in a circular pattern with radius ${radius}m around her. Calculate the area Oz covers.`,
                    hint: `Circle area = œÄr¬≤ where r = ${radius}m. Calculate ${radius}¬≤ first, then multiply by œÄ (‚âà 3.14159).`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Given: radius = ${radius}m<br>
                        2. Use formula: A = œÄr¬≤<br>
                        3. Step 1: ${radius}¬≤ = ${radius * radius}<br>
                        4. Step 2: A = 3.14159 √ó ${radius * radius} = ${area.toFixed(2)}<br>
                        <strong>Answer: ${area.toFixed(2)} m¬≤</strong>`,
                    diagram: (canvas) => drawCircle(canvas, radius, false, 0)
                }
            ];
            
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            return {
                text: scenario.text,
                hint: scenario.hint,
                explanation: scenario.explanation,
                diagram: scenario.diagram,
                answer: area,
                tolerance: 0.5,
                topic: "Circle Area",
                needsRounding: true
            };
        }

        function generateSurfaceAreaQuestion() {
            const l = Math.floor(Math.random() * 6) + 3;
            const w = Math.floor(Math.random() * 6) + 3;
            const h = Math.floor(Math.random() * 6) + 3;
            const surfaceArea = 2 * (l * w + l * h + w * h);
            
            const scenarios = [
                {
                    text: `Ningguang is commissioning a jade jewelry box for the Jade Chamber measuring ${l}cm √ó ${w}cm √ó ${h}cm. How much surface area needs to be covered with jade inlay?`,
                    hint: `A rectangular box has 6 faces. Surface Area = 2(lw + lh + wh). Calculate: 2(${l}√ó${w} + ${l}√ó${h} + ${w}√ó${h}).`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Surface Area of rectangular prism: SA = 2(lw + lh + wh)<br>
                        2. Given: l = ${l}cm, w = ${w}cm, h = ${h}cm<br>
                        3. Calculate each face area:<br>
                           - lw = ${l} √ó ${w} = ${l*w}<br>
                           - lh = ${l} √ó ${h} = ${l*h}<br>
                           - wh = ${w} √ó ${h} = ${w*h}<br>
                        4. Sum: ${l*w} + ${l*h} + ${w*h} = ${l*w + l*h + w*h}<br>
                        5. Multiply by 2: SA = 2 √ó ${l*w + l*h + w*h} = ${surfaceArea}<br>
                        <strong>Answer: ${surfaceArea} cm¬≤</strong>`
                },
                {
                    text: `Bennett found a treasure chest in a domain! It measures ${l}cm √ó ${w}cm √ó ${h}cm. He wants to cover it completely with protective coating. What's the total surface area?`,
                    hint: `For a rectangular prism: SA = 2(length √ó width) + 2(length √ó height) + 2(width √ó height). Plug in the values: l=${l}, w=${w}, h=${h}.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. We have a box with dimensions ${l} √ó ${w} √ó ${h} cm<br>
                        2. Formula: SA = 2(lw + lh + wh)<br>
                        3. Calculate: lw = ${l*w}, lh = ${l*h}, wh = ${w*h}<br>
                        4. Add them: ${l*w} + ${l*h} + ${w*h} = ${l*w + l*h + w*h}<br>
                        5. Double it: 2 √ó ${l*w + l*h + w*h} = ${surfaceArea} cm¬≤<br>
                        <strong>Answer: ${surfaceArea} cm¬≤</strong>`
                },
                {
                    text: `Xingqiu is wrapping a book as a gift. The book is ${l}cm √ó ${w}cm √ó ${h}cm. Calculate the wrapping paper needed (surface area).`,
                    hint: `Think of all 6 faces: top and bottom (2 √ó ${l}√ó${w}), front and back (2 √ó ${l}√ó${h}), left and right sides (2 √ó ${w}√ó${h}). Add them all up!`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. A rectangular box has 6 faces (3 pairs)<br>
                        2. Top/Bottom: 2 √ó (${l} √ó ${w}) = 2 √ó ${l*w} = ${2*l*w}<br>
                        3. Front/Back: 2 √ó (${l} √ó ${h}) = 2 √ó ${l*h} = ${2*l*h}<br>
                        4. Left/Right: 2 √ó (${w} √ó ${h}) = 2 √ó ${w*h} = ${2*w*h}<br>
                        5. Total: ${2*l*w} + ${2*l*h} + ${2*w*h} = ${surfaceArea} cm¬≤<br>
                        <strong>Answer: ${surfaceArea} cm¬≤</strong>`
                }
            ];
            
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            return {
                text: scenario.text,
                hint: scenario.hint,
                explanation: scenario.explanation,
                diagram: (canvas) => drawRectangularPrism(canvas, l, w, h),
                answer: surfaceArea,
                tolerance: 1,
                topic: "Surface Area",
                needsRounding: false
            };
        }

        function generateVolumeQuestion() {
            const type = Math.floor(Math.random() * 2);
            
            if (type === 0) {
                const radius = Math.floor(Math.random() * 5) + 2;
                const height = Math.floor(Math.random() * 8) + 4;
                const volume = Math.PI * radius * radius * height;
                
                return {
                    text: `Xiangling has a cylindrical pot at Wanmin Restaurant with radius ${radius}cm and height ${height}cm. What's the volume of Jueyun Chili soup it can hold?`,
                    hint: `Volume of a cylinder = œÄr¬≤h. Here r = ${radius}cm and h = ${height}cm. First calculate r¬≤ = ${radius * radius}, then multiply by œÄ and h.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Cylinder volume formula: V = œÄr¬≤h<br>
                        2. Given: r = ${radius}cm, h = ${height}cm<br>
                        3. Calculate r¬≤: ${radius}¬≤ = ${radius * radius}<br>
                        4. Multiply: V = œÄ √ó ${radius * radius} √ó ${height}<br>
                        5. V = 3.14159 √ó ${radius * radius * height} = ${volume.toFixed(2)} cm¬≥<br>
                        <strong>Answer: ${volume.toFixed(2)} cm¬≥</strong>`,
                    diagram: (canvas) => drawCylinder(canvas, radius, height),
                    answer: volume,
                    tolerance: 1,
                    topic: "Volume & Capacity",
                    needsRounding: true
                };
            } else {
                const l = Math.floor(Math.random() * 8) + 3;
                const w = Math.floor(Math.random() * 8) + 3;
                const h = Math.floor(Math.random() * 8) + 3;
                const volume = l * w * h;
                
                return {
                    text: `Hu Tao is calculating storage space at the Wangsheng Funeral Parlor. A storage box measures ${l}m √ó ${w}m √ó ${h}m. What's the volume?`,
                    hint: `Volume of a rectangular prism = length √ó width √ó height. Simply multiply: ${l} √ó ${w} √ó ${h}.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Rectangular prism volume: V = l √ó w √ó h<br>
                        2. Given: length = ${l}m, width = ${w}m, height = ${h}m<br>
                        3. Multiply all three dimensions:<br>
                        4. V = ${l} √ó ${w} √ó ${h} = ${volume} m¬≥<br>
                        <strong>Answer: ${volume} m¬≥</strong>`,
                    diagram: (canvas) => drawRectangularPrism(canvas, l, w, h),
                    answer: volume,
                    tolerance: 0.5,
                    topic: "Volume & Capacity",
                    needsRounding: false
                };
            }
        }

        function generateSimilarityQuestion() {
            const small = Math.floor(Math.random() * 5) + 3;
            const ratio = Math.floor(Math.random() * 3) + 2;
            const large = small * ratio;
            
            const type = Math.floor(Math.random() * 2);
            
            if (type === 0) {
                return {
                    text: `Albedo discovered similar Cryo crystals in Dragonspine. A small crystal has an edge of ${small}cm. A larger similar crystal has a scale factor of ${ratio}:1. What is the corresponding edge length of the larger crystal?`,
                    hint: `In similar figures, corresponding lengths are proportional. If the scale factor is ${ratio}:1, multiply the small crystal's edge by ${ratio}.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Similar figures have proportional corresponding sides<br>
                        2. Scale factor = ${ratio}:1 (larger : smaller)<br>
                        3. Small crystal edge = ${small}cm<br>
                        4. Large crystal edge = ${small} √ó ${ratio} = ${large}cm<br>
                        <strong>Answer: ${large} cm</strong>`,
                    answer: large,
                    tolerance: 0.1,
                    topic: "Congruence & Similarity",
                    needsRounding: false
                };
            } else {
                const smallArea = small * small;
                const largeArea = smallArea * ratio * ratio;
                return {
                    text: `Mona is studying similar magic circles. The smaller circle has an area of ${smallArea} cm¬≤. If a larger similar circle has a linear scale factor of ${ratio}:1, what is its area?`,
                    hint: `IMPORTANT: When scale factor for length is ${ratio}:1, the scale factor for AREA is ${ratio}¬≤:1 (or ${ratio * ratio}:1). Multiply the small area by ${ratio}¬≤.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Linear scale factor = ${ratio}:1<br>
                        2. Area scale factor = (linear scale factor)¬≤ = ${ratio}¬≤ = ${ratio * ratio}:1<br>
                        3. Small area = ${smallArea} cm¬≤<br>
                        4. Large area = ${smallArea} √ó ${ratio * ratio} = ${largeArea} cm¬≤<br>
                        5. Remember: Areas scale with the SQUARE of the linear scale!<br>
                        <strong>Answer: ${largeArea} cm¬≤</strong>`,
                    answer: largeArea,
                    tolerance: 1,
                    topic: "Similarity & Area",
                    needsRounding: false
                };
            }
        }

        function generateUnitCircleQuestion() {
            const angles = [0, 30, 45, 60, 90, 120, 135, 150, 180, 210, 225, 240, 270, 300, 315, 330];
            const angle = angles[Math.floor(Math.random() * angles.length)];
            const rad = angle * Math.PI / 180;
            
            const type = Math.floor(Math.random() * 2);
            
            if (type === 0) {
                const answer = Math.cos(rad);
                return {
                    text: `Lisa is calculating elemental reaction angles in her research. She needs cos(${angle}¬∞) for her Electro calculations. What is this value?`,
                    hint: `For special angles on the unit circle: cos(0¬∞)=1, cos(30¬∞)‚âà0.866, cos(45¬∞)‚âà0.707, cos(60¬∞)=0.5, cos(90¬∞)=0. Use these or your calculator!`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. We need to find cos(${angle}¬∞)<br>
                        2. Convert to radians if needed: ${angle}¬∞ = ${rad.toFixed(4)} radians<br>
                        3. Using unit circle or calculator: cos(${angle}¬∞) = ${answer.toFixed(4)}<br>
                        4. This represents the x-coordinate on the unit circle at ${angle}¬∞<br>
                        <strong>Answer: ${answer.toFixed(4)}</strong>`,
                    answer: answer,
                    tolerance: 0.01,
                    topic: "Unit Circle",
                    needsRounding: true
                };
            } else {
                const answer = Math.sin(rad);
                return {
                    text: `Sucrose is analyzing wind current trajectories. She needs to calculate sin(${angle}¬∞). What is this value?`,
                    hint: `For special angles: sin(0¬∞)=0, sin(30¬∞)=0.5, sin(45¬∞)‚âà0.707, sin(60¬∞)‚âà0.866, sin(90¬∞)=1. Use symmetry for other angles or your calculator.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. We need to find sin(${angle}¬∞)<br>
                        2. Convert to radians: ${angle}¬∞ = ${rad.toFixed(4)} radians<br>
                        3. Using unit circle or calculator: sin(${angle}¬∞) = ${answer.toFixed(4)}<br>
                        4. This represents the y-coordinate on the unit circle at ${angle}¬∞<br>
                        <strong>Answer: ${answer.toFixed(4)}</strong>`,
                    answer: answer,
                    tolerance: 0.01,
                    topic: "Unit Circle",
                    needsRounding: true
                };
            }
        }

        function generateBearingsQuestion() {
            const bearing1 = Math.floor(Math.random() * 90) + 30;
            const distance = Math.floor(Math.random() * 20) + 10;
            
            const scenarios = [
                {
                    text: `Beidou sails The Crux from Liyue Harbor on bearing ${bearing1}¬∞ for ${distance}km, then changes course to bearing ${bearing1 + 90}¬∞ for another ${distance}km. What is the straight-line distance from Liyue Harbor?`,
                    hint: `The two legs form a right angle (${bearing1}¬∞ and ${bearing1 + 90}¬∞ are perpendicular). Use Pythagoras: distance¬≤ = ${distance}¬≤ + ${distance}¬≤.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. First leg: ${distance}km on bearing ${bearing1}¬∞<br>
                        2. Second leg: ${distance}km on bearing ${bearing1 + 90}¬∞ (90¬∞ difference = right angle!)<br>
                        3. This forms a right triangle with both legs = ${distance}km<br>
                        4. Using Pythagorean Theorem: c¬≤ = ${distance}¬≤ + ${distance}¬≤<br>
                        5. c¬≤ = ${distance * distance} + ${distance * distance} = ${2 * distance * distance}<br>
                        6. c = ‚àö${2 * distance * distance} = ${Math.sqrt(2 * distance * distance).toFixed(2)} km<br>
                        <strong>Answer: ${Math.sqrt(2 * distance * distance).toFixed(2)} km</strong>`
                },
                {
                    text: `Kazuha follows wind currents ${distance}km on bearing ${bearing1}¬∞, then ${distance}km on bearing ${(bearing1 + 90) % 360}¬∞. Calculate his straight-line distance from the starting point.`,
                    hint: `These bearings differ by 90¬∞, creating a right triangle with both legs = ${distance}km. Apply Pythagorean theorem to find the hypotenuse.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Two legs of journey: ${distance}km and ${distance}km at right angles<br>
                        2. Forms a right triangle (90¬∞ difference in bearings)<br>
                        3. Use Pythagorean Theorem: c¬≤ = a¬≤ + b¬≤<br>
                        4. c¬≤ = ${distance}¬≤ + ${distance}¬≤ = ${distance * distance} + ${distance * distance}<br>
                        5. c¬≤ = ${2 * distance * distance}<br>
                        6. c = ‚àö${2 * distance * distance} = ${Math.sqrt(2 * distance * distance).toFixed(2)} km<br>
                        <strong>Answer: ${Math.sqrt(2 * distance * distance).toFixed(2)} km</strong>`
                }
            ];
            
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            const answer = Math.sqrt(2 * distance * distance);
            
            return {
                text: scenario.text,
                hint: scenario.hint,
                explanation: scenario.explanation,
                answer: answer,
                tolerance: 0.5,
                topic: "Bearings",
                needsRounding: true
            };
        }

        function generateTriangleAreaQuestion() {
            const base = Math.floor(Math.random() * 10) + 5;
            const height = Math.floor(Math.random() * 10) + 5;
            const area = 0.5 * base * height;
            
            const scenarios = [
                {
                    text: `Venti creates a triangular wind current with his Skyward Sonnet. The base spans ${base}m and the height reaches ${height}m. What's the area of this wind current?`,
                    hint: `Triangle area formula: A = ¬Ω √ó base √ó height. Calculate: ¬Ω √ó ${base} √ó ${height}.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Triangle area formula: A = ¬Ω √ó base √ó height<br>
                        2. Given: base = ${base}m, height = ${height}m<br>
                        3. Substitute: A = ¬Ω √ó ${base} √ó ${height}<br>
                        4. Calculate: A = ¬Ω √ó ${base * height} = ${area} m¬≤<br>
                        <strong>Answer: ${area} m¬≤</strong>`,
                    diagram: (canvas) => drawTriangle(canvas, base, height)
                },
                {
                    text: `Razor marks his wolf pack's territory with a triangular boundary. Base: ${base}m, height: ${height}m. What's the territory area?`,
                    hint: `Use A = (base √ó height) √∑ 2. Plug in: (${base} √ó ${height}) √∑ 2.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Formula: A = (base √ó height) √∑ 2<br>
                        2. base = ${base}m, height = ${height}m<br>
                        3. First multiply: ${base} √ó ${height} = ${base * height}<br>
                        4. Then divide by 2: ${base * height} √∑ 2 = ${area} m¬≤<br>
                        <strong>Answer: ${area} m¬≤</strong>`,
                    diagram: (canvas) => drawTriangle(canvas, base, height)
                },
                {
                    text: `Ganyu creates a triangular ice formation using her Celestial Shower. Base ${base}m, height ${height}m. Calculate the area.`,
                    hint: `Remember: Area = ¬Ωbh where b = ${base} and h = ${height}. Multiply base by height, then divide by 2.`,
                    explanation: `<strong>Step-by-step solution:</strong><br>
                        1. Triangle area: A = ¬Ωbh<br>
                        2. b = ${base}m, h = ${height}m<br>
                        3. Multiply: ${base} √ó ${height} = ${base * height}<br>
                        4. Divide by 2: ${base * height} √∑ 2 = ${area}<br>
                        <strong>Answer: ${area} m¬≤</strong>`,
                    diagram: (canvas) => drawTriangle(canvas, base, height)
                }
            ];
            
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            return {
                text: scenario.text,
                hint: scenario.hint,
                explanation: scenario.explanation,
                diagram: scenario.diagram,
                answer: area,
                tolerance: 0.5,
                topic: "Triangle Area",
                needsRounding: false
            };
        }

        function generateSineRuleQuestion() {
            const a = Math.floor(Math.random() * 10) + 8;
            const angleA = 30 + Math.floor(Math.random() * 30);
            const angleB = 40 + Math.floor(Math.random() * 30);
            
            const b = a * Math.sin(angleB * Math.PI / 180) / Math.sin(angleA * Math.PI / 180);
            
            return {
                text: `Yelan is triangulating positions in The Chasm. In a triangle, side a = ${a}m (opposite angle A = ${angleA}¬∞), and angle B = ${angleB}¬∞. Use the sine rule to find side b (opposite angle B).`,
                hint: `Sine Rule: a/sin(A) = b/sin(B). Rearrange to find b: b = a √ó sin(B) / sin(A). Calculate: b = ${a} √ó sin(${angleB}¬∞) / sin(${angleA}¬∞).`,
                explanation: `<strong>Step-by-step solution:</strong><br>
                    1. Sine Rule: a/sin(A) = b/sin(B)<br>
                    2. Given: a = ${a}m, A = ${angleA}¬∞, B = ${angleB}¬∞<br>
                    3. Rearrange to find b: b = a √ó sin(B) / sin(A)<br>
                    4. Calculate: sin(${angleB}¬∞) = ${Math.sin(angleB * Math.PI / 180).toFixed(4)}<br>
                    5. Calculate: sin(${angleA}¬∞) = ${Math.sin(angleA * Math.PI / 180).toFixed(4)}<br>
                    6. b = ${a} √ó ${Math.sin(angleB * Math.PI / 180).toFixed(4)} / ${Math.sin(angleA * Math.PI / 180).toFixed(4)}<br>
                    7. b = ${b.toFixed(2)} m<br>
                    <strong>Answer: ${b.toFixed(2)} m</strong>`,
                answer: b,
                tolerance: 0.5,
                topic: "Sine Rule",
                needsRounding: true
            };
        }

        function generateCircleTheoremQuestion() {
            const radius = Math.floor(Math.random() * 8) + 5;
            const chordDistance = Math.floor(Math.random() * (radius - 2)) + 1;
            
            const chordHalf = Math.sqrt(radius * radius - chordDistance * chordDistance);
            const chord = 2 * chordHalf;
            
            return {
                text: `Ayaka studies a circular frozen pond in Inazuma with radius ${radius}m. A chord (straight line across the circle) is ${chordDistance}m from the center. Using circle theorems, find the chord's length.`,
                hint: `Draw a perpendicular from the center to the chord - it bisects the chord! This creates a right triangle: radius = ${radius}m (hypotenuse), distance = ${chordDistance}m (one leg). Find the other leg, then double it for the full chord.`,
                explanation: `<strong>Step-by-step solution:</strong><br>
                    1. Circle Theorem: A perpendicular from center to chord bisects the chord<br>
                    2. This creates a right triangle where:<br>
                       - Hypotenuse = radius = ${radius}m<br>
                       - One leg = distance to chord = ${chordDistance}m<br>
                       - Other leg = half the chord length<br>
                    3. Using Pythagorean Theorem: (half-chord)¬≤ = ${radius}¬≤ - ${chordDistance}¬≤<br>
                    4. (half-chord)¬≤ = ${radius * radius} - ${chordDistance * chordDistance} = ${radius * radius - chordDistance * chordDistance}<br>
                    5. half-chord = ‚àö${radius * radius - chordDistance * chordDistance} = ${chordHalf.toFixed(2)}m<br>
                    6. Full chord = 2 √ó ${chordHalf.toFixed(2)} = ${chord.toFixed(2)}m<br>
                    <strong>Answer: ${chord.toFixed(2)} m</strong>`,
                diagram: (canvas) => drawCircle(canvas, radius, true, chordDistance),
                answer: chord,
                tolerance: 0.5,
                topic: "Circle Theorems",
                needsRounding: true
            };
        }

        function startGame() {
            currentQuestion = 0;
            score = 0;
            questions = [];
            
            // Select 5 random question types
            const shuffled = [...questionGenerators].sort(() => Math.random() - 0.5);
            for (let i = 0; i < 5; i++) {
                questions.push(shuffled[i]());
            }
            
            document.getElementById('score').textContent = score;
            document.getElementById('questionSection').classList.remove('hidden');
            document.getElementById('finalScore').classList.add('hidden');
            
            showQuestion();
        }

        function showQuestion() {
            const question = questions[currentQuestion];
            
            // Update map progress
            updateMapProgress();
            
            const roundingText = question.needsRounding ? " (Round to 2 decimal places)" : "";
            document.getElementById('questionNumber').textContent = `Quest ${currentQuestion + 1}/5 - ${question.topic}`;
            document.getElementById('questionText').textContent = question.text + roundingText;
            
            // Draw diagram if available
            const diagramContainer = document.getElementById('diagramContainer');
            if (question.diagram) {
                // Create canvas with initial size, drawing function will adjust if needed
                diagramContainer.innerHTML = '<canvas id="questionCanvas" width="400" height="300"></canvas>';
                const canvas = document.getElementById('questionCanvas');
                question.diagram(canvas);
            } else {
                diagramContainer.innerHTML = '';
            }
            
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('hintContainer').innerHTML = '';
            document.getElementById('hintContainer').classList.add('hidden');
            document.getElementById('answerExplanation').innerHTML = '';
            document.getElementById('answerExplanation').classList.add('hidden');
            document.getElementById('answerInput').focus();
            document.getElementById('hintBtn').disabled = false;
            document.getElementById('showAnswerBtn').disabled = false;
            document.getElementById('submitBtn').disabled = false;
            
            hintUsed = false;
            answerShown = false;
            maxScore = 20;
            currentAnswer = question.answer;
        }

        function updateMapProgress() {
            // Reset all locations
            for (let i = 0; i <= 5; i++) {
                const location = document.getElementById(`location${i}`);
                location.classList.remove('visited', 'current');
            }
            
            // Mark visited locations
            for (let i = 0; i < currentQuestion; i++) {
                document.getElementById(`location${i}`).classList.add('visited');
            }
            
            // Mark current location
            document.getElementById(`location${currentQuestion}`).classList.add('current');
        }

        function showHint() {
            const question = questions[currentQuestion];
            const hintContainer = document.getElementById('hintContainer');
            
            hintContainer.innerHTML = `<div class="hint-box">üí° <strong>Hint:</strong> ${question.hint}</div>`;
            hintContainer.classList.remove('hidden');
            
            hintUsed = true;
            maxScore = 10;
            document.getElementById('hintBtn').disabled = true;
        }

        function showAnswer() {
            const question = questions[currentQuestion];
            const answerContainer = document.getElementById('answerExplanation');
            
            answerContainer.innerHTML = `<div class="answer-explanation">üìñ <strong>Complete Solution:</strong><br><br>${question.explanation}</div>`;
            answerContainer.classList.remove('hidden');
            
            answerShown = true;
            maxScore = 1;
            document.getElementById('showAnswerBtn').disabled = true;
            document.getElementById('hintBtn').disabled = true;
        }

        function checkAnswer() {
            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const question = questions[currentQuestion];
            const feedback = document.getElementById('feedback');
            
            if (isNaN(userAnswer)) {
                feedback.innerHTML = '<div class="feedback incorrect">Please enter a valid number!</div>';
                return;
            }
            
            const isCorrect = Math.abs(userAnswer - question.answer) <= question.tolerance;
            
            if (isCorrect) {
                score += maxScore;
                document.getElementById('score').textContent = score;
                
                let feedbackMessage = '';
                if (answerShown) {
                    feedbackMessage = `
                        <div class="feedback correct">
                            ‚úì Correct! You earned ${maxScore} Primogem! 
                            <br>The answer is ${question.answer.toFixed(2)}
                            <br><em>(Full solution viewed: 1 point awarded)</em>
                        </div>
                    `;
                } else if (hintUsed) {
                    feedbackMessage = `
                        <div class="feedback correct">
                            ‚≠ê Correct! You earned ${maxScore} Primogems! ‚≠ê
                            <br>The answer is ${question.answer.toFixed(2)}
                            <br><em>(Hint used: Half points awarded)</em>
                        </div>
                    `;
                } else {
                    feedbackMessage = `
                        <div class="feedback correct">
                            ‚≠ê Perfect! You earned ${maxScore} Primogems! ‚≠ê
                            <br>The answer is ${question.answer.toFixed(2)}
                        </div>
                    `;
                }
                feedback.innerHTML = feedbackMessage;
            } else {
                feedback.innerHTML = `
                    <div class="feedback incorrect">
                        Not quite right. The correct answer is ${question.answer.toFixed(2)}
                        <br>Keep practicing, Traveler! üí™
                    </div>
                `;
            }
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('hintBtn').disabled = true;
            document.getElementById('showAnswerBtn').disabled = true;
            
            setTimeout(() => {
                currentQuestion++;
                
                // Check if we should trigger mini-game (after question 2 or 4, randomly)
                if (!miniGameTriggered && currentQuestion < 5 && (currentQuestion === 2 || currentQuestion === 4) && Math.random() < 0.5) {
                    miniGameTriggered = true;
                    startMiniGame();
                } else if (currentQuestion < 5) {
                    showQuestion();
                } else {
                    showFinalScore();
                }
            }, 3000);
        }

        function startMiniGame() {
            const modal = document.getElementById('miniGameModal');
            const container = document.getElementById('miniGameContainer');
            
            document.getElementById('miniGameTitle').textContent = 'üéÆ Bonus Challenge: Slime Whacker! üéÆ';
            
            container.innerHTML = `
                <p style="text-align: center; font-size: 1.1em; color: #666; margin-bottom: 20px;">
                    Quick! Help Amber clear out the slimes invading Mondstadt!<br>
                    Click the slimes as fast as you can!
                </p>
                <div class="game-timer" id="miniGameTimer">Time: 10s</div>
                <div class="game-score" id="miniGameScore">Slimes Defeated: 0</div>
                <div class="slime-grid" id="slimeGrid">
                    <div class="slime-hole" onclick="whackSlime(0)"></div>
                    <div class="slime-hole" onclick="whackSlime(1)"></div>
                    <div class="slime-hole" onclick="whackSlime(2)"></div>
                    <div class="slime-hole" onclick="whackSlime(3)"></div>
                    <div class="slime-hole" onclick="whackSlime(4)"></div>
                    <div class="slime-hole" onclick="whackSlime(5)"></div>
                    <div class="slime-hole" onclick="whackSlime(6)"></div>
                    <div class="slime-hole" onclick="whackSlime(7)"></div>
                    <div class="slime-hole" onclick="whackSlime(8)"></div>
                </div>
            `;
            
            modal.classList.add('active');
            
            // Start the game
            window.miniGameActive = true;
            window.miniGameScore = 0;
            window.miniGameTime = 10;
            window.activeSlimes = [];
            
            // Slime emojis
            window.slimeTypes = ['üíß', 'üî•', '‚ö°', 'üåø', '‚ùÑÔ∏è', 'üí®'];
            
            // Start spawning slimes
            window.slimeInterval = setInterval(spawnSlime, 800);
            
            // Start timer
            window.timerInterval = setInterval(() => {
                window.miniGameTime--;
                document.getElementById('miniGameTimer').textContent = `Time: ${window.miniGameTime}s`;
                
                if (window.miniGameTime <= 0) {
                    endMiniGame();
                }
            }, 1000);
        }

        function spawnSlime() {
            if (!window.miniGameActive) return;
            
            // Choose random hole
            const holeIndex = Math.floor(Math.random() * 9);
            const hole = document.querySelectorAll('.slime-hole')[holeIndex];
            
            // Don't spawn if already has slime
            if (hole.querySelector('.slime')) return;
            
            // Choose random slime type
            const slimeType = window.slimeTypes[Math.floor(Math.random() * window.slimeTypes.length)];
            
            // Add slime
            const slimeElement = document.createElement('span');
            slimeElement.className = 'slime';
            slimeElement.textContent = slimeType;
            slimeElement.dataset.index = holeIndex;
            hole.appendChild(slimeElement);
            
            window.activeSlimes[holeIndex] = true;
            
            // Remove slime after 1.5 seconds if not clicked
            setTimeout(() => {
                if (hole.contains(slimeElement)) {
                    hole.removeChild(slimeElement);
                    window.activeSlimes[holeIndex] = false;
                }
            }, 1500);
        }

        function whackSlime(index) {
            if (!window.miniGameActive) return;
            
            const hole = document.querySelectorAll('.slime-hole')[index];
            const slime = hole.querySelector('.slime');
            
            if (slime && window.activeSlimes[index]) {
                // Successful hit!
                window.miniGameScore++;
                document.getElementById('miniGameScore').textContent = `Slimes Defeated: ${window.miniGameScore}`;
                
                // Visual feedback
                hole.style.background = 'linear-gradient(135deg, #90EE90 0%, #98FB98 100%)';
                setTimeout(() => {
                    hole.style.background = 'linear-gradient(135deg, #8B7355 0%, #A0826D 100%)';
                }, 200);
                
                hole.removeChild(slime);
                window.activeSlimes[index] = false;
            }
        }

        function endMiniGame() {
            window.miniGameActive = false;
            clearInterval(window.slimeInterval);
            clearInterval(window.timerInterval);
            
            // Calculate bonus primogems (1 per slime, max 10)
            const bonusPrimogems = Math.min(window.miniGameScore, 10);
            score += bonusPrimogems;
            document.getElementById('score').textContent = score;
            
            const container = document.getElementById('miniGameContainer');
            
            let message = '';
            if (window.miniGameScore >= 15) {
                message = 'üåü Amazing! You\'re as quick as Diluc with his claymore!';
            } else if (window.miniGameScore >= 10) {
                message = '‚≠ê Great job! Bennett would be proud of your adventuring skills!';
            } else if (window.miniGameScore >= 5) {
                message = 'üëç Good effort! Keep practicing and you\'ll be a pro slime hunter!';
            } else {
                message = 'üí™ Those slimes are tricky! Better luck next time, Traveler!';
            }
            
            container.innerHTML = `
                <div class="mini-game-result">
                    <p style="font-size: 2em; margin: 20px 0;">Time's Up!</p>
                    <p style="font-size: 1.5em; color: #667eea; margin: 10px 0;">
                        You defeated ${window.miniGameScore} slimes!
                    </p>
                    <p style="font-size: 1.3em; color: #f5576c; margin: 20px 0;">
                        üíé Bonus: +${bonusPrimogems} Primogems!
                    </p>
                    <p style="color: #666; margin: 20px 0;">${message}</p>
                    <button class="continue-btn" onclick="closeMiniGame()">Continue Quest</button>
                </div>
            `;
        }

        function closeMiniGame() {
            document.getElementById('miniGameModal').classList.remove('active');
            
            if (currentQuestion < 5) {
                showQuestion();
            } else {
                showFinalScore();
            }
        }

        function showFinalScore() {
            document.getElementById('questionSection').classList.add('hidden');
            document.getElementById('finalScore').classList.remove('hidden');
            document.getElementById('finalPrimogems').textContent = score;
            
            // Update map to show all locations as visited
            for (let i = 0; i <= 5; i++) {
                const location = document.getElementById(`location${i}`);
                location.classList.remove('current');
                location.classList.add('visited');
            }
            
            let message = '';
            if (score === 100) {
                message = 'üåü Perfect! You are a true scholar of Teyvat! The Sumeru Akademiya would be proud! üåü';
            } else if (score >= 80) {
                message = '‚ú® Excellent work! Your skills rival the Liyue Qixing! Keep it up! ‚ú®';
            } else if (score >= 60) {
                message = 'üëç Good effort! With practice, you\'ll master these techniques like the Knights of Favonius! üëç';
            } else if (score >= 40) {
                message = 'üí™ Keep training! Even the greatest adventurers started somewhere. Try using hints next time! üí™';
            } else {
                message = 'üéØ Don\'t give up, Traveler! Remember, hints are there to help you learn. Let\'s try again! üéØ';
            }
            
            document.getElementById('performanceMessage').textContent = message;
        }

        function restartGame() {
            miniGameTriggered = false;
            startGame();
        }

        // Handle Enter key
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                    checkAnswer();
                }
            });
            startGame();
        });
    </script>
</body>
</html>